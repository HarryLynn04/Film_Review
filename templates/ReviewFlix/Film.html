{% extends 'ReviewFlix/base.html' %}

{% block title_block %}
    {{ film.Title }}
{% endblock %}

{% block body_block %}
    <h1>{{ film.Title }}</h1>
    <p><strong>Genre:</strong> {{ film.Genre }}</p>
    <p><strong>Description:</strong> {{ film.Description }}</p>
    <p><strong>Release Date:</strong> {{ film.ReleaseDate }}</p>
    <p><strong>Director:</strong> {{ film.Director }}</p>
    <p><strong>Cast:</strong> {{ film.Cast }}</p>
    {% if film.image %}
        <img src="{{ film.image.url }}" alt="{{ film.Title }} Image">
    {% endif %}
    <h2>Reviews:</h2>

    <div class="review-container">
        {% if reviews %}
            <p>Average Rating: {{ average_rating }}</p>
            <ul>
                {% for review in reviews %}
                    <div class="review">
                        <p class="review-author">Author: {{ review.Username }}</p>
                        <p class="review-rating">Rating: {{ review.Rating }}</p>
                        <p class="review-description">Description: {{ review.Description }}</p>
                        <p class="review-likes">Likes: <span id="likes-count-{{ review.id }}">{{ review.likes }}</span></p>
                        <p class="review-date">Published on: {{ review.DatePublished }}</p>
                        <button class="like-btn" data-review-id="{{ review.id }}">Like</button>
                    </div>
                {% endfor %}
            </ul>
        {% else %}
            <p class="no-reviews">No reviews available for this film.</p>
        {% endif %}
    </div>

    <a href="{% url 'ReviewFlix:FilmReview' film_id=film.id %}">Write a Review</a>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $(".like-btn").click(function() {
                var reviewId = $(this).data("review-id");
                $.ajax({
                    url: "{% url 'ReviewFlix:like_review' %}",
                    type: "POST",
                    data: {
                        review_id: reviewId,
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    dataType: "json",
                    success: function(response) {
                        if (response.status === "success") {
                            var newLikes = response.new_likes;
                            $("#likes-count-" + reviewId).text(newLikes);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            });
        });
    </script>
{% endblock %}
